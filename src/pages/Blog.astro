---
import BaseLayout from "../layout/BaseLayout.astro";
---
<BaseLayout title="Manage Blogs">
  <div class="max-w-4xl mx-auto p-6 text-black">
    <div class="bg-white p-6 rounded-xl shadow-md mb-10 border border-gray-200">
      <h2 id="formTitle" class="text-xl font-bold mb-4">Create New Post</h2>
      <input type="hidden" id="postId" />
      <input type="text" id="postTitle" placeholder="Blog Title" class="w-full p-2 border rounded mb-4 bg-white" />
      <textarea id="postContent" placeholder="Write content..." class="w-full p-2 border rounded h-40 mb-4 bg-white"></textarea>
      
      <div class="flex items-center">
        <button id="saveBtn" class="bg-pink-600 text-white px-6 py-2 rounded font-bold hover:bg-pink-700">Save Post</button>
        <button id="cancelBtn" class="hidden text-gray-500 ml-4 underline hover:text-black">Cancel Edit</button>
      </div>
    </div>

    <h2 class="text-xl font-bold mb-4">Publicly Published Posts</h2>
    <div id="userPosts" class="space-y-4">
      <p class="text-gray-400 italic">Loading posts...</p>
    </div>
  </div>

  <script>
    import { supabase } from '../supabase.js';

  
    interface Post {
      id: string;
      title: string;
      content: string;
      created_at: string;
    }

    declare global {
      interface Window {
        deletePost: (id: string) => Promise<void>;
        editPost: (id: string, title: string, content: string) => void;
      }
    }

    const titleIn = document.querySelector('#postTitle') as HTMLInputElement;
    const contentIn = document.querySelector('#postContent') as HTMLTextAreaElement;
    const idIn = document.querySelector('#postId') as HTMLInputElement;
    const postList = document.querySelector('#userPosts') as HTMLElement;
    const formH2 = document.querySelector('#formTitle') as HTMLElement;
    const cancelB = document.querySelector('#cancelBtn') as HTMLButtonElement;

 
    async function loadAllPosts() {
      const { data, error } = await supabase
        .from('blogs')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        postList.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        return;
      }

     
      const posts = (data as Post[]) || [];

      postList.innerHTML = posts.length 
        ? posts.map((post) => `
          <div class="p-4 bg-gray-50 border rounded-lg flex justify-between items-center shadow-sm">
            <div>
              <h3 class="font-bold text-lg text-black">${post.title}</h3>
              <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleDateString()}</p>
            </div>
            <div class="flex gap-4">
              <button onclick="editPost('${post.id}', \`${post.title.replace(/'/g, "\\'")}\`, \`${post.content.replace(/'/g, "\\'")}\` )" class="text-blue-600 font-bold hover:underline">Edit</button>
              <button onclick="deletePost('${post.id}')" class="text-red-600 font-bold hover:underline">Delete</button>
            </div>
          </div>
        `).join('') 
        : '<p class="text-gray-400">No posts yet. Start writing above!</p>';
    }

   
    document.querySelector('#saveBtn')?.addEventListener('click', async () => {
      const title = titleIn.value.trim();
      const content = contentIn.value.trim();

      if (!title || !content) return alert("Please fill in both title and content.");

  
      const payload = { 
        title: title, 
        content: content,
        author_name: "Guest" 
      };

      const query = idIn.value 
        ? supabase.from('blogs').update(payload).eq('id', idIn.value) 
        : supabase.from('blogs').insert(payload);

      const { error } = await query;
      
      if (error) {
        alert("Database Error: " + error.message);
      } else {
        titleIn.value = '';
        contentIn.value = '';
        idIn.value = '';
        formH2.innerText = "Create New Post";
        cancelB.classList.add('hidden');
        await loadAllPosts();
      }
    });

    window.deletePost = async (id: string) => {
      if (confirm("Permanently delete this post?")) {
        const { error } = await supabase.from('blogs').delete().eq('id', id);
        if (error) alert(error.message);
        else await loadAllPosts();
      }
    };

    window.editPost = (id, title, content) => {
      idIn.value = id;
      titleIn.value = title;
      contentIn.value = content;
      formH2.innerText = "Edit Post";
      cancelB.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    cancelB.onclick = () => {
        titleIn.value = '';
        contentIn.value = '';
        idIn.value = '';
        formH2.innerText = "Create New Post";
        cancelB.classList.add('hidden');
    };

   
    loadAllPosts();
  </script>
</BaseLayout>



