---
const { postSlug } = Astro.props;
---

<section class="max-w-2xl mx-auto mt-10 p-5 border-t border-gray-200">
  <h3 class="font-bold text-xl mb-4 text-black">Comments for {postSlug}</h3>
  
  <textarea id="commentInput" class="w-full p-2 border rounded text-black" placeholder="Type here..."></textarea>
  <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 mt-2 rounded font-bold hover:bg-blue-700">Post Comment</button>
 
  <div id="commentsList" class="mt-8 space-y-4">
    <p class="text-gray-400 italic">Loading comments...</p>
  </div>
</section>



<script>
import { supabase } from '../supabase.js';


const initComments = async () => {
  const currentSlug = window.location.pathname;
  const list = document.querySelector('#commentsList');
  const postBtn = document.querySelector('#postCommentBtn');
  const commentInput = document.querySelector('#commentInput') as HTMLTextAreaElement;

  async function displayComments() {
    const { data, error } = await supabase
      .from('comments')
      .select('*')
      .eq('post_slug', currentSlug)
      .order('created_at', { ascending: true });

    if (error) return console.error(error.message);

    if (list && data) {
      const html = data.map((c: any) => `
        <div class="p-3 border-b border-gray-100">
          <p class="font-bold text-sm text-blue-600">${c.username}</p>
          <p class="text-gray-800">${c.content}</p>
        </div>
      `).join('');
      list.innerHTML = html || '<p class="text-gray-400">No comments yet!</p>';
    }
  }
  if (postBtn) {
    
    postBtn.replaceWith(postBtn.cloneNode(true));
    const newBtn = document.querySelector('#postCommentBtn');

    newBtn?.addEventListener('click', async () => {
      const content = commentInput.value.trim();
      if (!content) return;

      (newBtn as HTMLButtonElement).disabled = true;

      const { error } = await supabase.from('comments').insert({
        post_slug: currentSlug,
        content: content,
        username: 'Guest'
      });

      if (error) {
        alert("Permission Error: Check your SQL Policies!");
      } else {
        commentInput.value = '';
        await displayComments();
      }
      (newBtn as HTMLButtonElement).disabled = false;
    });
  }

  displayComments();
};


document.addEventListener('astro:page-load', initComments);

initComments();
</script>

