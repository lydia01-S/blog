---
const { postSlug } = Astro.props;
---

<section class="max-w-2xl mx-auto mt-10 p-5 border-t border-gray-200">
  <h3 class="font-bold text-xl mb-4 text-black">Comments</h3>
  
  <textarea id="commentInput" class="w-full p-2 border rounded text-black bg-white" placeholder="Write a public comment..."></textarea>
  <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 mt-2 rounded font-bold hover:bg-blue-700">Post Comment</button>
 
  <div id="commentsList" class="mt-8 space-y-4">
    <p class="text-gray-400 italic">Loading...</p>
  </div>
</section>

<script>
import { supabase } from '../supabase.js';


interface CommentData {
  content: string;
  created_at: string;
}

const currentSlug = window.location.pathname;

async function displayComments() {
  const { data, error } = await supabase
    .from('comments')
    .select('content, created_at')
    .eq('post_slug', currentSlug) 
    .order('created_at', { ascending: true });

  if (error) return console.error("Error loading comments:", error.message);

  const list = document.querySelector('#commentsList');
  if (list) {
   
    const comments = (data as CommentData[]) || [];
    
    list.innerHTML = comments.map((c) => `
      <div class="p-3 bg-gray-50 rounded border border-gray-100">
        <p class="text-xs text-gray-400 mb-1">${new Date(c.created_at).toLocaleDateString()}</p>
        <p class="text-gray-800">${c.content}</p>
      </div>
    `).join('') || '<p class="text-gray-400">No comments yet.</p>';
  }
}

const postBtn = document.querySelector('#submitBtn');
const commentInput = document.querySelector('#commentInput') as HTMLTextAreaElement;

postBtn?.addEventListener('click', async () => {
  const content = commentInput.value.trim();
  if (!content) return;

  const btn = postBtn as HTMLButtonElement;
  btn.disabled = true;
  btn.innerText = "Posting...";

  const { error } = await supabase.from('comments').insert({
    post_slug: currentSlug,
    content: content
  });

  if (error) {
    alert("Error: " + error.message);
  } else {
    commentInput.value = '';
    await displayComments(); 
  }
  
  btn.disabled = false;
  btn.innerText = "Post Comment";
});


displayComments();
</script>

